<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Adicionar Caixa</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i&amp;display=swap">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/css/styles.min.css">
</head>

<body id="page-top" onload="selecionarMaquinas(), listarCaixas(), validarSessao(), verificarCargo(), obterDadosTodasMaquinas()">
    <span id="mensagem_erro" class="ms"></span>
    <div id="wrapper">
        <nav class="navbar navbar-dark align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0"
            style="background: rgb(0, 132, 156);">
            <div class="container-fluid d-flex flex-column p-0"><a
                    class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                    <div class="sidebar-brand-icon"><img src="assets/img/logo/logoWhite.png" width="60%"
                            style="margin-top: 10%;"></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul id="accordionSidebar" class="navbar-nav text-light">
                    <li class="nav-item"><a class="nav-link" href="listarUser.html" id="link_list_user"><i
                                class="fas fa-user"></i><span>Lista de usuários</span></a><a class="nav-link"
                            href="addUser.html" id="link_add_user"><i class="fas fa-user-plus"></i><span>Adicionar
                                Usuário</span></a><a class="nav-link" href="addCaixa.html" id="link_add_caixa"><i
                                class="fas fa-server"></i><span>Cadastrar Caixa</span></a><a class="nav-link"
                            href="dashMapa.html" id="link_dash_mapa"><i class="fas fa-map"></i><span>Dash -
                                Região</span></a><a class="nav-link" href="dashProcesso.html" id="link_dash_proc"><i
                                    class="fas fa-user"></i><span>Dash - Processos</span></a><a class="nav-link" href="dashOciosidade.html" id="link_dash_mapa"><i
                                class="fas fa-map"></i><span>Dash -
                                Ociosidade</span></a></li>
                    <li class="nav-item"><a id="link_dash" class="nav-link" data-bs-toggle="collapse" href="#div_caixas"
                            role="button" aria-expanded="false" aria-controls="div_caixas"><i
                                class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                        <div class="collapse show" id="div_caixas">
                        </div>
                    </li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0"
                        id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-light navbar-expand bg-white shadow mb-4 topbar static-top">
                    <div class="container-fluid">
                        <h5 style="color: var(--bs-navbar-brand-color);" id="titulo_cargo">Administrador</h5>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown no-arrow mx-1"></li>
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="shadow dropdown-list dropdown-menu dropdown-menu-end"
                                    aria-labelledby="alertsDropdown"></div>
                            </li>
                            <div class="d-none d-sm-block topbar-divider"></div>
                            <li class="nav-item dropdown no-arrow">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link"
                                        aria-expanded="false" data-bs-toggle="dropdown" href="#"><span
                                            class="d-none d-lg-inline me-2 text-gray-600 small" id="span_user">Kash
                                            User</span><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                                            viewBox="0 0 24 24" fill="none" style="font-size: 33px;">
                                            <path
                                                d="M5.12104 17.8037C7.15267 16.6554 9.4998 16 12 16C14.5002 16 16.8473 16.6554 18.879 17.8037M15 10C15 11.6569 13.6569 13 12 13C10.3431 13 9 11.6569 9 10C9 8.34315 10.3431 7 12 7C13.6569 7 15 8.34315 15 10ZM21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round"></path>
                                        </svg></a>
                                    <div class="dropdown-menu shadow dropdown-menu-end animated--grow-in"><a
                                            class="dropdown-item" onclick="limparSessao()"><i
                                                class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>&nbsp;Sair</a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
                <div class="container-fluid">
                    <h3 class="text-dark mb-4">Dash Ociosidade</h3>
                    <div class="row mb-3">
                        <div class="col-auto col-lg-8 col-xl-12">
                            <div class="row">
                                <div class="col-lg-12 col-xl-12 offset-lg-3 offset-xl-0">
                                    <div class="card shadow mb-3">
                                        <div class="card-header py-3">
                                            <p class="text-primary m-0 fw-bold">Lista de Caixas</p>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col">
                                                    <div id="div_primeiro_componente">
                                                        <select class="form-select" id="slct_maquinas">

                                                        </select>
                                                    </div>

                                                    <div class="text-center mb-3"><button class="btn btn-primary btn-sm"
                                                            onclick="obterDadosGraficosOciosidade()"
                                                            id="btn_cadastro" style="margin-top: 2%;">Mostrar
                                                            Maquina</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 col-xl-4 mb-4">
                            <div id="cpu_cor" class="card shadow border-start-primary py-2">
                                <div class="card-body">
                                    <div class="row align-items-center no-gutters">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-primary fw-bold text-l mb-1 text-center">
                                                <span>Inicio do monitoramento</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0 text-center"><span
                                                    id="span_inicioMonitoramento"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-xl-4 mb-4">
                            <div id="ram_cor" class="card shadow border-start-success py-2">
                                <div class="card-body">
                                    <div class="row align-items-center no-gutters">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-success fw-bold text-l mb-1 text-center">
                                                <span style="color: deepskyblue;">Tempo de ultilização</span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0 text-center"><span
                                                    id="span_tempoUso"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 col-xl-4 mb-4">
                            <div id="ram_cor" class="card shadow border-start-success py-2">
                                <div class="card-body">
                                    <div class="row align-items-center no-gutters">
                                        <div class="col me-2">
                                            <div class="text-uppercase text-success fw-bold text-l mb-1 text-center">
                                                <span>Tempo Ocioso </span>
                                            </div>
                                            <div class="text-dark fw-bold h5 mb-0 text-center"><span
                                                    id="span_tempoOcioso"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Inicio Gráficos -->

                        <div class="row">
                            <div class="col">
                                <h3 id="aviso_componente">Selecione alguma maquina para mostrar o gráfico</h3>
                                <div class="card shadow mb-4" id="card_cpu" style="display: none;">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="text-primary fw-bold m-0">Uso da maquina(milisegundos)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-area"
                                            style="display: flex; align-items: center; justify-content: center;">
                                            <div class="chart-container" id="grafico_cpu"
                                                style="position: relative; width: 80vw;">
                                                <canvas id="myChartCpu">
                                                </canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fim Gráficos -->


                    </div>

                </div>
                <div class="container-fluid">
                    <h3 class="text-dark mb-4">Listas de Maquinas</h3>
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="table-responsive table mt-2" id="dataTable" role="grid"
                                aria-describedby="dataTable_info">
                                <table class="table my-0" id="dataTable">
                                    <thead>
                                        <tr>
                                            <th>Número Serial</th>
                                            <th>Nome</th>
                                            <th>Tempo Ocioso(%)</th>
                                            <th>CEP</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table_body">
                                    </tbody>
                                    <tfoot>
                                        <tr></tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <footer class="bg-white sticky-footer">
                    <div class="container my-auto">
                        <div class="text-center my-auto copyright"><span>Copyright © KASH+&nbsp;2022</span></div>
                    </div>
                </footer>
            </div>
        </div>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script src="assets/js/script.min.js"></script>
        <script src="../js/funcoes.js"></script>
        <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
            integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
</body>

</html>
<script>

    let proximaAtualizacao;

    function selecionarMaquinas() {

        var cnpjVar = sessionStorage.BANCO_ID;

        fetch("/usuarios/selecionarMaquinas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                cnpjServer: cnpjVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {

                resposta.json().then(json => {

                    const select = document.querySelector('#slct_maquinas');

                    for (let i = 0; i < json.length; i++) {
                        select.options[select.options.length] = new Option(json[i].nome, json[i].serialNumber);
                    }
                });

            } else {

                console.log("Houve um erro ao tentar realizar o login!");

                resposta.text().then(texto => {
                    mensagem_erro.classList.add("erro")
                    mensagem_erro.style.display = "flex";
                    mensagem_erro.innerHTML = texto;
                    setTimeout(() => {
                        mensagem_erro.style.display = "none";
                        mensagem_erro.classList.remove("alerta");
                        mensagem_erro.innerHTML = "";
                    }, "5000")
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

    function obterDadosGraficosOciosidade() {
        serialNumber = slct_maquinas.value;

        document.getElementById("myChartCpu").remove();

        var divGrafico = document.getElementById("grafico_cpu");
        var canvas = document.createElement("canvas");
        canvas.id = "myChartCpu";

        divGrafico.appendChild(canvas);

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao); 
        }

        fetch(`/medidas/ultimasOciosidade/${serialNumber}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    card_cpu.style.display = "block";
                    aviso_componente.style.display = "none";

                    usuario = resposta[0].usoUsuario;
                    ocioso = resposta[0].usoOcioso;
                    console.log("Uso do usuário: " + usuario);
                    console.log("Uso ocioso: " + ocioso);
                    tempoTotalUtilizacao = usuario + ocioso;
                    
                    tempoTotalUtilizacao = new Date(tempoTotalUtilizacao * 1000);
                    diaTempoTotalUtilizacao = tempoTotalUtilizacao.getUTCDate() - 1;
                    horaTempoTotalUtilizacao = tempoTotalUtilizacao.getUTCHours();

                    //Data de hoje - data do registro
                    dataInicio = new Date();
                    dataInicio.setDate(dataInicio.getDate() - diaTempoTotalUtilizacao);
                    dataInicio.setHours(dataInicio.getHours() - horaTempoTotalUtilizacao);
                    diaInicio = dataInicio.getDate();
                    mesInicio = dataInicio.getMonth() + 1;
                    anoInicio = dataInicio.getFullYear();
                    horaInicio = dataInicio.getHours();
                    minutoInicio = dataInicio.getMinutes();
                    segundoInicio = dataInicio.getSeconds();

                    // console.log(diaInicio + "/" + mesInicio + "/" + anoInicio + " " + horaInicio + ":" + minutoInicio + ":" + segundoInicio);

                    usoUsuario = new Date(resposta[0].usoUsuario * 1000);
                    daysUsuario = usoUsuario.getUTCDate() - 1;
                    hoursUsuario = usoUsuario.getUTCHours();
                    minutesUsuario = usoUsuario.getUTCMinutes();
                    secondsUsuario = usoUsuario.getSeconds();

                    usoOcioso = new Date(resposta[0].usoOcioso * 1000);
                    daysOcioso = usoOcioso.getUTCDate() - 1;
                    hoursOcioso = usoOcioso.getUTCHours();
                    minutesOcioso = usoOcioso.getUTCMinutes();
                    secondsOcioso = usoOcioso.getSeconds();

                    span_inicioMonitoramento.innerHTML = diaInicio + "/" + mesInicio + "/" + anoInicio + " " + horaInicio + ":" + minutoInicio + ":" + segundoInicio;

                    if(daysUsuario > 0){
                        span_tempoUso.innerHTML = daysUsuario + " Dias " + hoursUsuario + " Horas " + minutesUsuario + " Minutos ";
                    } else {
                        span_tempoUso.innerHTML = hoursUsuario + " Horas " + minutesUsuario + " Minutos ";
                    }

                    if(daysOcioso > 0){
                        span_tempoOcioso.innerHTML = daysOcioso + " Dias " + hoursOcioso + " Horas " + minutesOcioso + " Minutos ";
                    } else {
                        span_tempoOcioso.innerHTML = hoursOcioso + " Horas " + minutesOcioso + " Minutos ";
                    }
                    
                    resposta.reverse();

                    plotarGraficoTempoUso(resposta, serialNumber);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGraficoTempoUso(resposta, serialNumber) {

        let labels = [];

        var dados = {
            labels: labels,
            datasets: [
                {
                    yAxisID: 'y-usoMaquina',
                    label: 'Uso da maquina(milisegundos)',
                    lineTension: 0.3,
                    backgroundColor: "rgba(78, 115, 223, 0.5)",
                    borderColor: "rgba(78, 115, 223, 1)",
                    pointRadius: 3,
                    pointBackgroundColor: "rgba(78, 115, 223, 1)",
                    pointBorderColor: "rgba(78, 115, 223, 1)",
                    pointHoverRadius: 3,
                    pointHoverBackgroundColor: "rgba(78, 115, 223, 1)",
                    pointHoverBorderColor: "rgba(78, 115, 223, 1)",
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    data: [0, 50, 20, 45, 10, 30, 22, 55, 35, 10, 95, 50],
                    fill: true,
                    data: [],
                },
            ],
            options: {
                maintainAspectRatio: false,
                responsive: true
            }
        };

        for (i = 0; i < resposta.length; i++) {
            labels.push(resposta[i].datahora);
            dados.datasets[0].data.push(resposta[i].usoUsuario);
        }

        const config = {
            type: 'line',
            data: dados,
            options: {
                maintainAspectRatio: false,
                responsive: true,
            }
        };

        let myChartCpu = new Chart(
            document.getElementById('myChartCpu'),
            config
        );

        setTimeout(() => atualizarGraficoTempoUso(serialNumber, dados, myChartCpu), 10000);
    }

    function atualizarGraficoTempoUso(serialNumber, dados, myChartCpu) {

        fetch(`/medidas/tempo-realUso/${serialNumber}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    usoUsuario = new Date(novoRegistro[0].usoUsuario * 1000);
                    daysUsuario = usoUsuario.getUTCDate() - 1;
                    hoursUsuario = usoUsuario.getUTCHours();
                    minutesUsuario = usoUsuario.getUTCMinutes();
                    secondsUsuario = usoUsuario.getSeconds();

                    usoOcioso = new Date(novoRegistro[0].usoOcioso * 1000);
                    daysOcioso = usoOcioso.getUTCDate() - 1;
                    hoursOcioso = usoOcioso.getUTCHours();
                    minutesOcioso = usoOcioso.getUTCMinutes();
                    secondsOcioso = usoOcioso.getSeconds();

                    if(daysUsuario > 0){
                        span_tempoUso.innerHTML = daysUsuario + " Dias " + hoursUsuario + " Horas " + minutesUsuario + " Minutos ";
                    } else {
                        span_tempoUso.innerHTML = hoursUsuario + " Horas " + minutesUsuario + " Minutos ";
                    }

                    if(daysOcioso > 0){
                        span_tempoOcioso.innerHTML = daysOcioso + " Dias " + hoursOcioso + " Horas " + minutesOcioso + " Minutos ";
                    } else {
                        span_tempoOcioso.innerHTML = hoursOcioso + " Horas " + minutesOcioso + " Minutos ";
                    }

                    // CpuCor(novoRegistro[0].usoUsuario);

                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro[0].datahora); // incluir um novo momento

                    dados.datasets[0].data.shift();
                    dados.datasets[0].data.push((novoRegistro[0].usoUsuario));

                    myChartCpu.update();


                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGraficoTempoUso(serialNumber, dados, myChartCpu), 30000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGraficoTempoUso(serialNumber, dados, myChartCpu), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function obterDadosTodasMaquinas() {

        var cnpjVar = sessionStorage.BANCO_ID;

        fetch("/usuarios/obterDadosTodasMaquinas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                cnpjServer: cnpjVar
            })
        }).then(function (resposta) {

            if (resposta.ok) {

                resposta.json().then(json => {
                    console.log("Respostas todas as maquinas: " + JSON.stringify(json));

                    var tabela = document.getElementById("table_body");

                    for(i = 0; i < json.length; i++){

                        serialNumber = json[i].fkMaquina;
                        nome = json[i].nome;
                        tempoTotalUso = json[i].usoOcioso + json[i].usoUsuario;
                        mediaOciosoDiario = (json[i].usoOcioso / tempoTotalUso) * 100;
                        mediaOciosoDiario = mediaOciosoDiario.toFixed(1);
                        cep = json[i].cep;

                        var linha = document.createElement('tr');
                        tabela.appendChild(linha);

                        var colunaSerialNumber = document.createElement('td');
                        linha.appendChild(colunaSerialNumber);
                        colunaSerialNumber.innerHTML = serialNumber;

                        var colunaNome = document.createElement('td');
                        linha.appendChild(colunaNome);
                        colunaNome.innerHTML = nome;

                        var colunaUsoOcioso = document.createElement('td');
                        linha.appendChild(colunaUsoOcioso);
                        colunaUsoOcioso.innerHTML = mediaOciosoDiario + '%';

                        var colunaCep = document.createElement('td');
                        linha.appendChild(colunaCep);
                        colunaCep.innerHTML = cep;
                    }
                });

            } else {

                console.log("Houve um erro ao tentar realizar o login!");

                resposta.text().then(texto => {
                    mensagem_erro.classList.add("erro")
                    mensagem_erro.style.display = "flex";
                    mensagem_erro.innerHTML = texto;
                    setTimeout(() => {
                        mensagem_erro.style.display = "none";
                        mensagem_erro.classList.remove("alerta");
                        mensagem_erro.innerHTML = "";
                    }, "5000")
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

</script>